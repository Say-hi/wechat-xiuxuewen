{"version":3,"sources":["pages/courseOffline/courseOffline.js"],"names":["app","getApp","bmap","require","Page","data","testImg","page","lists","title","onShareAppMessage","gs","t","path","imageUrl","g","showMore","e","setData","canShowIndex","currentTarget","dataset","index","showImg","bindex","oindex","room_images","open_site","console","log","detail","authSetting","wx","showToast","openType","that","setTimeout","Bmap","choose_site","chooseLocation","success","res","address","latitude","longitude","site","BMap","BMapWX","ak","regeocoding","location","addressInfo","getNear","fail","wxrequest","url","getUrl","dotNearby","code","originalData","result","addressComponent","adcode","lng","lat","parent_code","user_id","id","hideLoading","status","total","v","s","split","distance","toFixed","concat","more","pre_page","length","setToast","content","desc","onReachBottom","search","dotSearch","dot_name","searchText","sd","city_name","onLoad","setBar","onReady","onShow","onHide","onUnload","onPullDownRefresh"],"mappings":"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","file":"courseOffline.js","sourcesContent":["// 获取全局应用程序实例对象\nconst app = getApp()\nconst bmap = require('../../utils/bmap-wx')\n// 创建页面实例对象\nPage({\n  /**\n   * 页面的初始数据\n   */\n  data: {\n    testImg: app.data.testImg,\n    page: 0,\n    lists: [],\n    title: 'courseOffline'\n  },\n  onShareAppMessage () {\n    return {\n      title: app.gs('shareText').t || '绣学问，真纹绣',\n      path: `/pages/index/index`,\n      imageUrl: app.gs('shareText').g\n    }\n  },\n  showMore (e) {\n    this.setData({\n      canShowIndex: e.currentTarget.dataset.index\n    })\n  },\n  showImg (e) {\n    this.data.showImg = 1\n    app.showImg(this.data.lists[e.currentTarget.dataset.bindex].lists[e.currentTarget.dataset.oindex].room_images[e.currentTarget.dataset.index], this.data.lists[e.currentTarget.dataset.bindex].lists[e.currentTarget.dataset.oindex].room_images)\n  },\n  /**\n   * 地址授权\n   * @param e\n   */\n  open_site (e) {\n    console.log('setting')\n    if (e.detail.authSetting['scope.userLocation']) {\n      wx.showToast({\n        title: '授权成功'\n      })\n      this.setData({\n        openType: null\n      })\n      let that = this\n      setTimeout(function () {\n        that.Bmap(that)\n      }, 100)\n    }\n  },\n  choose_site () {\n    console.log('choose')\n    let that = this\n    if (!this.data.openType) {\n      wx.chooseLocation({\n        success (res) {\n          that.setData({\n            address: res.address,\n            latitude: res.latitude,\n            longitude: res.longitude\n          }, that.Bmap(that, `${res.longitude},${res.latitude}`))\n        }\n      })\n    }\n  },\n  /**\n   * 百度地图函数\n   * @param that\n   * @constructor\n   */\n  Bmap (that, site) {\n    let BMap = new bmap.BMapWX({\n      ak: 'RBTsmFCaerZ25VkuGhpSIZa5lyC36BcV'\n    })\n    BMap.regeocoding({\n      location: site || null,\n      success (res) {\n        that.data.page = 0\n        that.data.lists = []\n        that.setData({\n          addressInfo: res\n        }, that.getNear)\n      },\n      fail (data) {\n        that.setData({\n          openType: 'openSetting'\n        })\n        console.log('fail', data)\n      }\n    })\n  },\n  getNear () {\n    let that = this\n    app.wxrequest({\n      url: app.getUrl().dotNearby,\n      data: {\n        code: that.data.addressInfo.originalData.result.addressComponent.adcode,\n        longitude: that.data.addressInfo.originalData.result.location.lng,\n        latitude: that.data.addressInfo.originalData.result.location.lat,\n        parent_code: that.data.parent_code || 0,\n        user_id: app.gs('userInfoAll').id,\n        page: ++that.data.page\n      },\n      success (res) {\n        wx.hideLoading()\n        if (res.data.status === 200) {\n          if (res.data.data.total < 1 && !that.data.parent_code) {\n            that.data.parent_code = 1\n            that.data.page <= 1 ? that.data.page = 0 : null\n            that.getNear()\n          } else {\n            for (let v of res.data.data.lists) {\n              for (let s of v.lists) {\n                s.room_images = s.room_images.split(',')\n                s.distance = s.distance > 1000 ? (s.distance / 1000).toFixed(2) + 'km' : s.distance + 'm'\n              }\n            }\n            that.setData({\n              lists: that.data.lists.concat(res.data.data.lists),\n              more: res.data.data.pre_page > res.data.data.lists.length ? 0 : 1\n            })\n          }\n        } else {\n          app.setToast(that, {content: res.data.desc})\n        }\n      }\n    })\n  },\n  onReachBottom () {\n    if (this.data.more > 0) this.getNear()\n    else app.setToast(this, {content: '没有更多门店啦'})\n  },\n\n  search () {\n    let that = this\n    app.wxrequest({\n      url: app.getUrl().dotSearch,\n      data: {\n        page: 1,\n        dot_name: that.data.searchText\n      },\n      success (res) {\n        wx.hideLoading()\n        if (res.data.status === 200) {\n          for (let s of res.data.data.lists) {\n            s.room_images = s.room_images.split(',')\n            if (that.data.addressInfo) {\n              let sd = app.distance(s.latitude, s.longitude, that.data.addressInfo.originalData.result.location.lat, that.data.addressInfo.originalData.result.location.lng)\n              s.distance = sd > 1000 ? (sd / 1000).toFixed(2) + 'km' : sd + 'm'\n            }\n          }\n          that.data.lists[0] = {\n            city_name: '搜索结果',\n            lists: !that.data.lists[0] ? res.data.data.lists : that.data.lists[0].lists.concat(res.data.data.lists)\n          }\n          that.setData({\n            lists: that.data.lists,\n            more: res.data.data.pre_page > res.data.data.lists.length ? 0 : 1\n          })\n        } else {\n          app.setToast(that, {content: '未搜索到相关内容'})\n        }\n      }\n    })\n  },\n  /**\n   * 生命周期函数--监听页面加载\n   */\n  onLoad () {\n    this.Bmap(this)\n    app.setBar('线下学堂')\n    // TODO: onLoad\n  },\n\n  /**\n   * 生命周期函数--监听页面初次渲染完成\n   */\n  onReady () {\n    // TODO: onReady\n  },\n\n  /**\n   * 生命周期函数--监听页面显示\n   */\n  onShow () {\n    if (this.data.showImg === 1) {\n      this.data.showImg = 0\n    } else if (app.data.searchText) {\n      this.data.searchText = app.data.searchText\n      app.data.searchText = null\n      this.data.lists = []\n      this.search()\n    }\n  },\n\n  /**\n   * 生命周期函数--监听页面隐藏\n   */\n  onHide () {\n    // TODO: onHide\n  },\n\n  /**\n   * 生命周期函数--监听页面卸载\n   */\n  onUnload () {\n    // TODO: onUnload\n  },\n\n  /**\n   * 页面相关事件处理函数--监听用户下拉动作\n   */\n  onPullDownRefresh () {\n    this.data.page = 0\n    this.data.lists = []\n    this.getNear()\n    // TODO: onPullDownRefresh\n  }\n})\n"]}