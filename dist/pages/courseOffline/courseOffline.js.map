{"version":3,"sources":["pages/courseOffline/courseOffline.js"],"names":["app","getApp","bmap","require","Page","data","testImg","page","lists","title","onShareAppMessage","gs","path","showMore","e","setData","canShowIndex","currentTarget","dataset","index","showImg","bindex","oindex","room_images","open_site","console","log","detail","authSetting","wx","showToast","openType","that","setTimeout","Bmap","choose_site","chooseLocation","success","res","address","latitude","longitude","site","BMap","BMapWX","ak","regeocoding","location","addressInfo","getNear","fail","wxrequest","url","getUrl","dotNearby","code","originalData","result","addressComponent","adcode","lng","lat","parent_code","user_id","id","hideLoading","status","total","v","s","split","distance","toFixed","concat","more","pre_page","length","setToast","content","desc","onReachBottom","search","dotSearch","dot_name","searchText","sd","city_name","onLoad","setBar","onReady","onShow","onHide","onUnload","onPullDownRefresh"],"mappings":"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","file":"courseOffline.js","sourcesContent":["// 获取全局应用程序实例对象\nconst app = getApp()\nconst bmap = require('../../utils/bmap-wx')\n// 创建页面实例对象\nPage({\n  /**\n   * 页面的初始数据\n   */\n  data: {\n    testImg: app.data.testImg,\n    page: 0,\n    lists: [],\n    title: 'courseOffline'\n  },\n  onShareAppMessage () {\n    return {\n      title: app.gs('shareText') || '绣学问，真纹绣',\n      path: `/pages/index/index`\n    }\n  },\n  showMore (e) {\n    this.setData({\n      canShowIndex: e.currentTarget.dataset.index\n    })\n  },\n  showImg (e) {\n    this.data.showImg = 1\n    app.showImg(this.data.lists[e.currentTarget.dataset.bindex].lists[e.currentTarget.dataset.oindex].room_images[e.currentTarget.dataset.index], this.data.lists[e.currentTarget.dataset.bindex].lists[e.currentTarget.dataset.oindex].room_images)\n  },\n  /**\n   * 地址授权\n   * @param e\n   */\n  open_site (e) {\n    console.log('setting')\n    if (e.detail.authSetting['scope.userLocation']) {\n      wx.showToast({\n        title: '授权成功'\n      })\n      this.setData({\n        openType: null\n      })\n      let that = this\n      setTimeout(function () {\n        that.Bmap(that)\n      }, 100)\n    }\n  },\n  choose_site () {\n    console.log('choose')\n    let that = this\n    if (!this.data.openType) {\n      wx.chooseLocation({\n        success (res) {\n          that.setData({\n            address: res.address,\n            latitude: res.latitude,\n            longitude: res.longitude\n          }, that.Bmap(that, `${res.longitude},${res.latitude}`))\n        }\n      })\n    }\n  },\n  /**\n   * 百度地图函数\n   * @param that\n   * @constructor\n   */\n  Bmap (that, site) {\n    let BMap = new bmap.BMapWX({\n      ak: 'RBTsmFCaerZ25VkuGhpSIZa5lyC36BcV'\n    })\n    BMap.regeocoding({\n      location: site || null,\n      success (res) {\n        that.data.page = 0\n        that.data.lists = []\n        that.setData({\n          addressInfo: res\n        }, that.getNear)\n      },\n      fail (data) {\n        that.setData({\n          openType: 'openSetting'\n        })\n        console.log('fail', data)\n      }\n    })\n  },\n  getNear () {\n    let that = this\n    app.wxrequest({\n      url: app.getUrl().dotNearby,\n      data: {\n        code: that.data.addressInfo.originalData.result.addressComponent.adcode,\n        longitude: that.data.addressInfo.originalData.result.location.lng,\n        latitude: that.data.addressInfo.originalData.result.location.lat,\n        parent_code: that.data.parent_code || 0,\n        user_id: app.gs('userInfoAll').id,\n        page: ++that.data.page\n      },\n      success (res) {\n        wx.hideLoading()\n        if (res.data.status === 200) {\n          if (res.data.data.total < 1 && !that.data.parent_code) {\n            that.data.parent_code = 1\n            that.data.page <= 1 ? that.data.page = 0 : null\n            that.getNear()\n          } else {\n            for (let v of res.data.data.lists) {\n              for (let s of v.lists) {\n                s.room_images = s.room_images.split(',')\n                s.distance = s.distance > 1000 ? (s.distance / 1000).toFixed(2) + 'km' : s.distance + 'm'\n              }\n            }\n            that.setData({\n              lists: that.data.lists.concat(res.data.data.lists),\n              more: res.data.data.pre_page > res.data.data.lists.length ? 0 : 1\n            })\n          }\n        } else {\n          app.setToast(that, {content: res.data.desc})\n        }\n      }\n    })\n  },\n  onReachBottom () {\n    if (this.data.more > 0) this.getNear()\n    else app.setToast(this, {content: '没有更多门店啦'})\n  },\n\n  search () {\n    let that = this\n    app.wxrequest({\n      url: app.getUrl().dotSearch,\n      data: {\n        page: 1,\n        dot_name: that.data.searchText\n      },\n      success (res) {\n        wx.hideLoading()\n        if (res.data.status === 200) {\n          for (let s of res.data.data.lists) {\n            s.room_images = s.room_images.split(',')\n            if (that.data.addressInfo) {\n              let sd = app.distance(s.latitude, s.longitude, that.data.addressInfo.originalData.result.location.lat, that.data.addressInfo.originalData.result.location.lng)\n              s.distance = sd > 1000 ? (sd / 1000).toFixed(2) + 'km' : sd + 'm'\n            }\n          }\n          that.data.lists[0] = {\n            city_name: '搜索结果',\n            lists: !that.data.lists[0] ? res.data.data.lists : that.data.lists[0].lists.concat(res.data.data.lists)\n          }\n          that.setData({\n            lists: that.data.lists,\n            more: res.data.data.pre_page > res.data.data.lists.length ? 0 : 1\n          })\n        } else {\n          app.setToast(that, {content: '未搜索到相关内容'})\n        }\n      }\n    })\n  },\n  /**\n   * 生命周期函数--监听页面加载\n   */\n  onLoad () {\n    this.Bmap(this)\n    app.setBar('线下学堂')\n    // TODO: onLoad\n  },\n\n  /**\n   * 生命周期函数--监听页面初次渲染完成\n   */\n  onReady () {\n    // TODO: onReady\n  },\n\n  /**\n   * 生命周期函数--监听页面显示\n   */\n  onShow () {\n    if (this.data.showImg === 1) {\n      this.data.showImg = 0\n    } else if (app.data.searchText) {\n      this.data.searchText = app.data.searchText\n      app.data.searchText = null\n      this.data.lists = []\n      this.search()\n    }\n  },\n\n  /**\n   * 生命周期函数--监听页面隐藏\n   */\n  onHide () {\n    // TODO: onHide\n  },\n\n  /**\n   * 生命周期函数--监听页面卸载\n   */\n  onUnload () {\n    // TODO: onUnload\n  },\n\n  /**\n   * 页面相关事件处理函数--监听用户下拉动作\n   */\n  onPullDownRefresh () {\n    this.data.page = 0\n    this.data.lists = []\n    this.getNear()\n    // TODO: onPullDownRefresh\n  }\n})\n"]}